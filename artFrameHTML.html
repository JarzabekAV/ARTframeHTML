<!DOCTYPE html>
<!-- VIBECODED BE MATT JARZABEK - MATT@JARZABEK.CA - PoC for personal art display - this is a proof of concept prototype, use/try at your own risk-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Digital Art Frame Kiosk</title>
    <style>
        :root {
            --ui-bg: rgba(20, 20, 20, 0.85);
            --ui-accent: #d4af37;
            --text-color: #f0f0f0;
        }

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; background-color: #000;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body.hide-cursor { cursor: none; }

        #frame-container { position: relative; width: 100%; height: 100%; }

        /* Canvas Vignette Effect */
        #frame-container::after {
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            box-shadow: inset 0 0 150px rgba(0,0,0,0.9); pointer-events: none; z-index: 10;
        }

        .art-layer {
            position: absolute; top: -5%; left: -5%; width: 110%; height: 110%;
            background-size: contain; background-position: center; background-repeat: no-repeat;
            transition: opacity 2s ease-in-out;
            opacity: 0;
        }

        .active { opacity: 1; }

        .pan-1 { animation: pan1 60s linear forwards; }
        .pan-2 { animation: pan2 60s linear forwards; }
        .pan-3 { animation: pan3 60s linear forwards; }
        .pan-4 { animation: pan4 60s linear forwards; }

        @keyframes pan1 { 0% { transform: scale(1) translate(0, 0); } 100% { transform: scale(1.15) translate(-2%, -2%); } }
        @keyframes pan2 { 0% { transform: scale(1) translate(0, 0); } 100% { transform: scale(1.15) translate(2%, 2%); } }
        @keyframes pan3 { 0% { transform: scale(1) translate(0, 0); } 100% { transform: scale(1.15) translate(-2%, 2%); } }
        @keyframes pan4 { 0% { transform: scale(1) translate(0, 0); } 100% { transform: scale(1.15) translate(2%, -2%); } }

        #progress-container {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 2px;
            background: transparent; z-index: 150;
        }
        
        #progress-bar {
            height: 100%; width: 0%; 
            background: rgba(255, 255, 255, 0.2); 
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        #ui-overlay {
            position: absolute; bottom: 20px; left: 20px; z-index: 100;
            display: flex; flex-direction: column; gap: 10px;
            transition: opacity 0.5s ease-in-out;
            opacity: 1; pointer-events: auto;
        }

        .info-panel {
            background: var(--ui-bg); padding: 15px; border-radius: 8px;
            color: var(--text-color); border-left: 4px solid var(--ui-accent);
            max-width: 500px; backdrop-filter: blur(5px);
            display: flex; gap: 15px; align-items: center;
        }

        .info-text { flex-grow: 1; }

        .qr-code {
            width: 70px; height: 70px; border-radius: 4px; border: 2px solid white;
            background: white; display: none;
        }

        .controls {
            display: flex; gap: 10px; background: var(--ui-bg);
            padding: 10px; border-radius: 8px; width: fit-content; flex-wrap: wrap;
            backdrop-filter: blur(5px); align-items: center;
        }

        button, select {
            background: #333; color: white; border: 1px solid #555;
            padding: 8px 12px; cursor: pointer; border-radius: 4px;
            font-weight: bold; transition: background 0.2s;
        }

        button:hover { background: var(--ui-accent); color: black; }
        .btn-active { background: var(--ui-accent); color: black; }

        #history-panel {
            position: absolute; top: 20px; right: 20px; bottom: 20px;
            width: 320px; background: var(--ui-bg); border-radius: 8px;
            color: var(--text-color); z-index: 100;
            display: flex; flex-direction: column;
            transition: opacity 0.5s ease-in-out;
            opacity: 1; backdrop-filter: blur(5px);
            border-left: 4px solid var(--ui-accent); pointer-events: auto;
        }

        #history-panel h3 { margin: 15px; padding-bottom: 10px; border-bottom: 1px solid #444; }
        
        #history-list {
            flex-grow: 1; overflow-y: auto; padding: 0 15px 15px 15px;
            display: flex; flex-direction: column; gap: 8px;
        }

        .history-item {
            background: #2a2a2a; padding: 10px; border-radius: 6px;
            cursor: pointer; transition: background 0.2s, transform 0.1s;
        }

        .history-item:hover { background: #3a3a3a; transform: translateX(-5px); }
        .history-item.current { border-left: 4px solid var(--ui-accent); background: #222; }
        .hist-title { font-weight: bold; font-size: 0.9rem; margin-bottom: 4px; display: block;}
        .hist-artist { font-size: 0.75rem; color: #aaa; }

        .loading-spinner {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%); display: none;
            width: 40px; height: 40px; border: 4px solid rgba(255, 255, 255, 0.2);
            border-top: 4px solid var(--ui-accent); border-radius: 50%;
            animation: spin 1s linear infinite; z-index: 50;
        }

        @keyframes spin { 0% { transform: translate(-50%, -50%) rotate(0deg); } 100% { transform: translate(-50%, -50%) rotate(360deg); } }

        .ui-hidden { opacity: 0 !important; pointer-events: none !important; }

        h2, p { margin: 0 0 5px 0; }
        .meta { font-size: 0.85rem; color: #bbb; font-style: italic; }
        .hint { font-size: 0.75rem; color: var(--ui-accent); margin-top: 8px; opacity: 0.8;}
        
        .source-link { color: var(--ui-accent); text-decoration: none; transition: opacity 0.2s; }
        .source-link:hover { text-decoration: underline; opacity: 0.8; }

    </style>
</head>
<body>

    <div id="frame-container">
        <div id="layer1" class="art-layer active"></div>
        <div id="layer2" class="art-layer"></div>
    </div>

    <div id="loading" class="loading-spinner"></div>

    <div id="progress-container"><div id="progress-bar"></div></div>

    <div id="ui-overlay">
        <div class="info-panel" id="art-info">
            <div class="info-text">
                <h2 id="title">Initializing Gallery...</h2>
                <p id="artist">Connecting to Archives</p>
                <div class="meta" id="details">Please wait</div>
                <div class="hint">Hotkeys: [Space] Play/Pause | [‚Üê/‚Üí] Navigate | [S] Gallery | [F] Fullscreen</div>
            </div>
            <img id="qr-code" class="qr-code" src="" alt="Scan to view on museum website">
        </div>

        <div class="controls">
            <button id="play-btn" onclick="togglePlay()">‚è∏ [Space]</button>
            <button onclick="prevArt()">‚èÆ [‚Üê]</button>
            <button onclick="nextArt()">‚è≠ [‚Üí]</button>
            <select id="source-select" tabindex="-1">
                <option value="all">üåç Global Shuffle</option>
                <option value="met">The Metropolitan Museum</option>
                <option value="cma">Cleveland Museum of Art</option>
                <option value="va">Victoria & Albert Museum (UK)</option>
            </select>
            <select id="speed-select" tabindex="-1">
                <option value="10000">10s</option>
                <option value="30000" selected>30s</option>
                <option value="60000">1m</option>
                <option value="300000">5m</option>
            </select>
            <button id="pin-btn" onclick="togglePinUI()">üìå [Tab]</button>
            <button onclick="toggleFullscreen()">‚õ∂ [F]</button>
        </div>
    </div>

    <div id="history-panel">
        <h3>Session History</h3>
        <div id="history-list"></div>
    </div>

    <script>
        // Removed isHighlight=true from MET to unlock tens of thousands of paintings
        const CMA_API = "https://openaccess-api.clevelandart.org/api/artworks/?has_image=1&type=Painting&limit=1&skip=";
        const MET_API_SEARCH = "https://collectionapi.metmuseum.org/public/collection/v1/search?hasImages=true&q=painting";
        const MET_API_OBJECT = "https://collectionapi.metmuseum.org/public/collection/v1/objects/";
        const VA_API = "https://api.vam.ac.uk/v2/objects/search?q_object_type=painting&images_exist=1&page_size=1&page=";
        const QR_API = "https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=";

        let currentLayer = 1;
        let timer = null;
        let metIds = [];
        let isFetching = false;
        
        let isPlaying = true;
        let artHistory = [];
        let isUiPinned = false; 
        let currentHistoryIndex = 0; 

        const uiOverlay = document.getElementById('ui-overlay');
        const historyPanel = document.getElementById('history-panel');
        const pinBtn = document.getElementById('pin-btn');
        const progressBar = document.getElementById('progress-bar');
        const qrCodeEl = document.getElementById('qr-code');
        let hideTimeout;

        function setUiVisible(isVisible) {
            if (isVisible) {
                uiOverlay.classList.remove('ui-hidden');
                historyPanel.classList.remove('ui-hidden');
                document.body.classList.remove('hide-cursor');
            } else {
                uiOverlay.classList.add('ui-hidden');
                historyPanel.classList.add('ui-hidden');
                if (document.fullscreenElement) document.body.classList.add('hide-cursor');
            }
        }

        function resetIdleTimer() {
            if (isUiPinned) return;
            setUiVisible(true);
            clearTimeout(hideTimeout);
            hideTimeout = setTimeout(() => {
                if (!isUiPinned) setUiVisible(false);
            }, 3000);
        }

        document.addEventListener('fullscreenchange', () => {
            if (document.fullscreenElement) resetIdleTimer(); 
            else { document.body.classList.remove('hide-cursor'); setUiVisible(true); }
        });

        document.addEventListener('mousemove', resetIdleTimer);
        document.addEventListener('touchstart', resetIdleTimer);
        document.addEventListener('click', resetIdleTimer);

        function togglePinUI() {
            isUiPinned = !isUiPinned;
            if (isUiPinned) {
                clearTimeout(hideTimeout);
                setUiVisible(true);
                pinBtn.classList.add('btn-active');
            } else {
                pinBtn.classList.remove('btn-active');
                resetIdleTimer();
            }
        }

        window.addEventListener('keydown', (e) => {
            const key = e.key.toLowerCase();
            if ([' ', 'arrowright', 'arrowleft', 'tab', 'f', 's', 'm'].includes(key)) e.preventDefault();
            resetIdleTimer();
            if (key === 'tab' || key === 'm') togglePinUI();
            else if (key === ' ') togglePlay();
            else if (key === 'arrowright') nextArt();
            else if (key === 'arrowleft') prevArt();
            else if (key === 's') toggleSource();
            else if (key === 'f') toggleFullscreen();
        });

        function startProgressBar() {
            const ms = parseInt(document.getElementById('speed-select').value);
            progressBar.style.transition = 'none';
            progressBar.style.width = '0%';
            void progressBar.offsetWidth; 
            progressBar.style.transition = `width ${ms}ms linear`;
            progressBar.style.width = '100%';
        }

        function pauseProgressBar() {
            const currentWidth = window.getComputedStyle(progressBar).getPropertyValue('width');
            progressBar.style.transition = 'none';
            progressBar.style.width = currentWidth;
        }

        function togglePlay() {
            isPlaying = !isPlaying;
            const btn = document.getElementById('play-btn');
            if (isPlaying) {
                btn.innerText = "‚è∏ [Space]";
                btn.classList.remove('btn-active');
                if (currentHistoryIndex === 0) { startProgressBar(); resetTimer(); }
            } else {
                btn.innerText = "‚ñ∂ [Space]";
                btn.classList.add('btn-active');
                pauseProgressBar();
                clearTimeout(timer);
            }
        }

        function toggleSource() {
            const select = document.getElementById('source-select');
            let nextIndex = select.selectedIndex + 1;
            if (nextIndex >= select.options.length) nextIndex = 0;
            select.selectedIndex = nextIndex;
            
            if (currentHistoryIndex > 0) currentHistoryIndex = 0; 
            if (!isPlaying) togglePlay(); 
            fetchArt();
        }

        async function fetchArt() {
            if (isFetching) return;
            isFetching = true;
            
            progressBar.style.transition = 'none';
            progressBar.style.width = '0%';
            document.getElementById('loading').style.display = 'block';

            let source = document.getElementById('source-select').value;
            
            if (source === 'all') {
                const sources = ['met', 'cma', 'va'];
                source = sources[Math.floor(Math.random() * sources.length)];
            }

            // Cache Buster string added to bypass aggressive browser memory
            const cb = "&_t=" + Date.now();

            try {
                if (source === 'cma') {
                    const randomSkip = Math.floor(Math.random() * 3500);
                    const res = await fetch(CMA_API + randomSkip + cb);
                    const json = await res.json();
                    const data = json.data[0];
                    
                    let artistDisplay = data.creators && data.creators.length > 0 
                        ? (data.creators[0].description || data.creators[0].name) : "Unknown Artist";
                    
                    updateDisplay({
                        id: `cma-${data.id}`,
                        title: data.title || "Untitled",
                        artist: artistDisplay,
                        date: data.creation_date || "Unknown Date",
                        imgUrl: data.images.web.url,
                        source: "Cleveland Museum of Art",
                        pageUrl: data.url || `https://www.clevelandart.org/art/${data.id}`
                    });

                } else if (source === 'va') {
                    const randomPage = Math.floor(Math.random() * 2000) + 1;
                    const res = await fetch(VA_API + randomPage + cb);
                    const json = await res.json();
                    
                    if (!json.records || json.records.length === 0) throw new Error("Empty V&A");
                    const data = json.records[0];
                    if (!data._primaryImageId) throw new Error("No V&A image");
                    
                    updateDisplay({
                        id: `va-${data.systemNumber}`,
                        title: data._primaryTitle || "Untitled",
                        artist: data._primaryMaker?.name || "Unknown Artist",
                        date: data._primaryDate || "Unknown Date",
                        imgUrl: `https://framemark.vam.ac.uk/collections/${data._primaryImageId}/full/!1200,1200/0/default.jpg`,
                        source: "Victoria & Albert Museum",
                        pageUrl: `https://collections.vam.ac.uk/item/${data.systemNumber}`
                    });

                } else {
                    if (metIds.length === 0) {
                        const res = await fetch(MET_API_SEARCH);
                        const json = await res.json();
                        metIds = json.objectIDs;
                    }
                    const randomId = metIds[Math.floor(Math.random() * metIds.length)];
                    // Cache buster for MET object fetch
                    const objRes = await fetch(MET_API_OBJECT + randomId + "?_t=" + Date.now());
                    const data = await objRes.json();
                    
                    if (!data.primaryImage) throw new Error("No image");
                    
                    updateDisplay({
                        id: `met-${data.objectID}`,
                        title: data.title || "Untitled",
                        artist: data.artistDisplayName || "Unknown Artist",
                        date: data.objectDate || "Unknown Date",
                        imgUrl: data.primaryImage,
                        source: "The Metropolitan Museum of Art",
                        pageUrl: data.objectURL
                    });
                }
            } catch (e) {
                console.warn("Retrying:", e.message);
                isFetching = false;
                fetchArt(); // Will instantly grab a new random ID/Skip on failure
            }
        }

        function updateDisplay(info, isHistoryLoad = false) {
            const nextLayerNum = currentLayer === 1 ? 2 : 1;
            const currentEl = document.getElementById(`layer${currentLayer}`);
            const nextEl = document.getElementById(`layer${nextLayerNum}`);

            const img = new Image();
            img.src = info.imgUrl;
            
            img.onload = () => {
                nextEl.style.backgroundImage = `url('${info.imgUrl}')`;
                
                const randomPan = `pan-${Math.floor(Math.random() * 4) + 1}`;
                currentEl.className = 'art-layer'; 
                nextEl.className = `art-layer active ${randomPan}`; 
                
                document.getElementById('title').innerText = info.title;
                document.getElementById('artist').innerText = info.artist;
                
                let linkHtml = info.pageUrl 
                    ? `<a href="${info.pageUrl}" target="_blank" class="source-link" rel="noopener noreferrer">${info.source} üîó</a>`
                    : info.source;
                document.getElementById('details').innerHTML = `${info.date} ‚Ä¢ ${linkHtml}`;
                
                if (info.pageUrl) {
                    qrCodeEl.src = QR_API + encodeURIComponent(info.pageUrl);
                    qrCodeEl.style.display = "block";
                } else {
                    qrCodeEl.style.display = "none";
                }

                document.getElementById('loading').style.display = 'none';
                
                currentLayer = nextLayerNum;
                isFetching = false;

                if (!isHistoryLoad) {
                    artHistory.unshift(info);
                    if (artHistory.length > 50) artHistory.pop();
                    currentHistoryIndex = 0; 
                    renderHistoryList();
                } else {
                    highlightHistoryItem(info.id);
                }

                if (isPlaying && currentHistoryIndex === 0) {
                    startProgressBar();
                    resetTimer();
                }
            };

            img.onerror = () => {
                isFetching = false;
                if (!isHistoryLoad) fetchArt(); 
            };
        }

        function renderHistoryList() {
            const list = document.getElementById('history-list');
            list.innerHTML = ""; 

            artHistory.forEach((art, index) => {
                const div = document.createElement('div');
                div.className = `history-item ${index === 0 ? 'current' : ''}`;
                div.id = `hist-${art.id}`;
                div.innerHTML = `
                    <span class="hist-title">${art.title}</span>
                    <span class="hist-artist">${art.artist}</span>
                `;
                div.onclick = () => loadFromHistory(index);
                list.appendChild(div);
            });
        }

        function loadFromHistory(index) {
            currentHistoryIndex = index;
            if (isPlaying) togglePlay(); 
            const art = artHistory[index];
            document.getElementById('loading').style.display = 'block';
            updateDisplay(art, true);
        }

        function prevArt() { if (artHistory.length > 0 && currentHistoryIndex < artHistory.length - 1) loadFromHistory(currentHistoryIndex + 1); }
        function nextArt() {
            if (currentHistoryIndex > 0) loadFromHistory(currentHistoryIndex - 1);
            else { if (!isPlaying) togglePlay(); fetchArt(); }
        }

        function highlightHistoryItem(id) {
            document.querySelectorAll('.history-item').forEach(el => el.classList.remove('current'));
            const activeEl = document.getElementById(`hist-${id}`);
            if (activeEl) activeEl.classList.add('current');
        }

        function resetTimer() {
            if (timer) clearTimeout(timer);
            if (isPlaying && currentHistoryIndex === 0) {
                const ms = parseInt(document.getElementById('speed-select').value);
                timer = setTimeout(fetchArt, ms);
            }
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) document.documentElement.requestFullscreen();
            else document.exitFullscreen();
        }

        fetchArt();
        resetIdleTimer();
        document.getElementById('speed-select').onchange = () => {
            if (isPlaying) { startProgressBar(); resetTimer(); }
        };
        document.getElementById('source-select').onchange = fetchArt;

    </script>
</body>
</html>
